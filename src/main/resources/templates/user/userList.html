<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorator="~{layout/layout}">

<th:block layout:fragment="content">
    <!-- DataTales Example -->
    <div class="card shadow mb-4">
        <div class="card-header py-3">
            <h6 class="m-0 font-weight-bold text-primary">사용자 현황</h6>
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-bordered" width="100%" cellspacing="0">
                    <thead>
                    <tr>
                        <td>계정</td>
                        <td>이름</td>
                        <td>별명</td>
                        <td>Email</td>
                        <td>Actions</td>
                    </tr>
                    </thead>
                    <tbody id="table">

                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        $(function () {
            benopeAPI.findUserList()
                .then(handleUserList)
                .catch(console.error);
        });

        function handleUserList(data) {
            var tr = $(this).closest('tr');

            _.chain(data)
                .get('content')
                .forEach(function (user) {
                    var tr = $(makeTableBody(user));

                    tr.find('button').eq(0).on('click', function () {
                        resetUserPassword(user.username);
                    });
                    tr.find('button').eq(1).on('click', function () {
                        deleteUser(user.username, tr);
                    });

                    $('#table').append(tr);
                })
                .value();
        }

        function makeTableBody(user) {
            var html =
                "<tr>" +
                "{{#with user}}" +
                "   <td>{{username}}</td>" +
                "   <td>{{lastName}} {{firstName}}</td>" +
                "   <td>{{nickname}}</td>" +
                "   <td>{{email}}</td>" +
                "   <td class='text-center align-middle'>" +
                "       <div class='btn-group align-top'>" +
                "           <button class='btn btn-sm btn-outline-secondary badge'>비밀번호 초기화</button>" +
                "           <button class='btn btn-sm btn-outline-secondary badge'><i class='fa fa-trash'></i></button>" +
                "       </div>" +
                "   </td>" +
                "{{/with}}" +
                "</tr>";

            var template = Handlebars.compile(html);
            return template({user: user});
        }

        function resetUserPassword(username) {
            benopeUI.confirmModal("비밀번호 초기화", "초기화 하시겠습니까?", function () {
                benopeAPI.resetUserPassword(username)
                    .then(function () {
                        benopeUI.confirmModal("비밀번호 초기화", "초기화 되었습니다.");
                    })
                    .catch(function (e) {
                        benopeUI.confirmModal('비밀번호 초기화', e.message)
                    });
            });
        }

        function deleteUser(username, tr) {
            benopeUI.confirmModal("사용자 삭제", "삭제하시겠습니까?", function () {
                benopeAPI.deleteUser(username)
                    .then(function () {
                        tr.remove();
                        benopeUI.confirmModal("사용자 삭제", "삭제되었습니다.");
                    })
                    .catch(function (e) {
                        benopeUI.confirmModal('사용자 삭제', e.message)
                    });
            });
        }
    </script>

</th:block>

</html>